# machine Machine
# mongo_cluster MongoServerCluster
# mongodb MongoDbServer
# zone Zone

{% import 'common/ssh_help.py.j2' as ssh_help %}
{% import 'common/docker_help.py.j2' as docker_help %}
{% import 'common/mongo_help.py.j2' as mongo_help %}

{%- include "common/common_head.py.j2" %}
{%- set ssh_client = "ssh_client" %}
{{ ssh_help.invoke_shell(ssh_client, mongodb.locate_machine) }}


{{ docker_help.kill_container(ssh_client, mongodb.name) }}

{% set run_cmd = [ 
    docker_help.cmd_mkdir_volume_used(mongodb.db_path), 
    docker_help.cmd_mkdir_volume_used(mongodb.log_path, True),
] %}
{{ docker_help.exec_cmds(ssh_client, mongodb.image, run_cmd, network=mongodb.docker_ip.docker_net, volumes=zone.fo_used_volume_map.values()) }}

{% set run_cmd = mongo_help.mongodb_start_cmd(mongo_cluster, mongodb) %}
{{ docker_help.run_container(ssh_client, mongodb.name, mongodb.image, run_cmd, opt="-d", volumes=zone.fo_used_volume_map.values(), network=mongodb.docker_ip.docker_net, net_used=mongodb.docker_ip) }}


